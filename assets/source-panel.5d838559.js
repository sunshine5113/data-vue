var e=Object.defineProperty,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,i=(e,i)=>{for(var n in i||(i={}))t.call(i,n)&&s(e,n,i[n]);if(a)for(var n of a(i))l.call(i,n)&&s(e,n,i[n]);return e};import{d as n,aZ as d,e as o,y as r,z as c,l as u,m as p,F as v,p as f,v as g,A as m,r as b,ae as F,M as y,k as h,aq as w,q as C,ag as k,a_ as D,t as S,aH as _,az as N,ao as x,s as E,aG as j,aI as O,a$ as T,b0 as V,b1 as P,b2 as U,b3 as A,b4 as I}from"./index.15bc13ac.js";var M=n({name:"DisplayApiStatus",props:{status:{type:String,default:d.incomplete},loadingText:{type:String,default:"匹配中"},successText:{type:String,default:"匹配成功"},failedText:{type:String,default:"未找到字段"},completedText:{type:String,default:"配置完成"},incompleteText:{type:String,default:"配置未完成"},optional:{type:Boolean,default:!1}},setup(e){const a=o((()=>e.status===d.loading?e.loadingText:e.status===d.success?e.successText:e.status===d.completed?e.completedText:e.optional?"可选":e.status===d.failed?e.failedText:e.status===d.incomplete?e.incompleteText:e.status));return{apiStatus:d,statusText:a}}});const z=m();r("data-v-7213c838");const B=f("i",{class:"status-icon validating"},null,-1),q=f("i",{class:"status-icon validating"},null,-1),R=f("i",{class:"status-icon validating"},null,-1),$={key:2,class:"status-icon --success"},G={class:"status-text"};c();const L=z(((e,a,t,l,s,i)=>(u(),p("div",null,[e.status===e.apiStatus.loading?(u(),p(v,{key:0},[B,q,R],64)):e.status===e.apiStatus.success||e.status===e.apiStatus.completed?(u(),p("i",{key:1,class:["status-icon",`--${e.status}`]},null,2)):e.optional?(u(),p("i",$)):(u(),p("i",{key:3,class:["status-icon",`--${e.status}`]},null,2)),f("span",G,g(e.statusText),1)]))));M.render=L,M.__scopeId="data-v-7213c838";var H=n({name:"FilterCollapsePanel",props:{dataFilter:{type:Object,required:!0},isNew:Boolean},setup(e){const a=b(e.isNew),t=b(e.isNew),l=b(e.isNew),s=b(e.isNew),i=b(!1),n=b(e.dataFilter.origin),d=F("dataStatus"),r=o((()=>{let a="";const t=d.value.errFilter;return t&&t[e.dataFilter.id]&&(a=t[e.dataFilter.id]),a})),c=F("usedFilters"),u=F("enabledFilters"),p=F("onUsedChange"),v=F("editFilterName"),f=F("removeFilter"),g=F("saveFilter"),m=o((()=>{var a;return null!=(a=u.value[e.dataFilter.id])&&a}));return{code:n,loading:i,editing:a,collapse:t,isOpened:l,isEdited:s,isEnabled:m,usedFilters:c,enabledFilters:u,errMsg:r,switchEnabled:a=>{p(e.dataFilter.id,a)},editName:t=>{a.value=!1,v(t,e.dataFilter)},removeFilter:f,changeCode:a=>{a.value!=e.dataFilter.origin&&(s.value=!0)},updateCode:e=>{n.value=e.value},cancelEdit:()=>{e.isNew?f(0):(n.value=e.dataFilter.origin,s.value?s.value=!1:t.value=!1)},saveData:async()=>{if(s.value)try{i.value=!0,e.dataFilter.origin=n.value,e.dataFilter.code=`\n          if (!data) {  return data; }\n          return filter(...arguments);\n          function filter(data) {\n            ${n.value}\n            return data;\n          }\n        `,await g(e.dataFilter),t.value=!1,s.value=!1}catch(a){y.error(y.format(a))}finally{i.value=!1}else t.value=!1},toggleEditor:()=>{l.value=!0,t.value=!t.value}}}});const Z={class:"panel-header"},J={class:"panel-title"},K={class:"filter-title"},Q=f("i",{class:"v-icon-drag drag-btn",draggable:""},null,-1),W={class:"filter-name"},X={class:"action-wp --edit"},Y={class:"filter-count"},ee={class:"action-wp"},ae=f("div",{class:"filter-dot a"},null,-1),te={key:1,class:"filter-dot b"},le=f("i",{class:"el-icon-arrow-right toggle-icon"},null,-1),se={class:"panel-content-wp"},ie={class:"cp-wrap"},ne=f("p",{title:"function filter(data) {",class:"fake-code --start"},[f("span",{class:"--keyword"},"function"),S(" filter(data) { ")],-1),de=f("p",{class:"fake-code --end"},"}",-1),oe={class:"filter-actions"},re={key:0,class:"unsaved"};H.render=function(e,a,t,l,s,i){const n=h("el-checkbox"),d=h("g-input"),o=h("g-tooltip-popover"),r=h("el-tooltip"),c=h("g-monaco-editor"),m=h("el-button"),b=h("el-collapse-transition");return u(),p("div",{class:["collapse-panel-wp filter-item ds-panel-filter",{"--create":e.isNew,"--spread":e.collapse||e.isNew,"--draggable":!e.isNew,"--unused":!e.isEnabled,"--error":!!e.errMsg}]},[f("div",Z,[f("div",J,[f("div",K,[e.isNew?w("",!0):(u(),p(v,{key:0},[Q,f(n,{"model-value":e.isEnabled,class:"enable-checkbox",onChange:e.switchEnabled},null,8,["model-value","onChange"])],64)),f("div",W,[e.editing?(u(),p(d,{key:0,"model-value":e.dataFilter.name,autofocus:!0,class:"filter-name-input",onChange:e.editName},null,8,["model-value","onChange"])):(u(),p("div",{key:1,class:"filter-name-text",title:e.dataFilter.name},g(e.dataFilter.name),9,["title"]))]),f("div",X,[f(o,{content:"重命名"},{default:C((()=>[f("i",{class:"v-icon-edit edit-btn",onClick:a[1]||(a[1]=a=>e.editing=!0)})])),_:1})]),f("div",Y,[e.isNew?w("",!0):(u(),p(r,{key:0,content:e.usedFilters[e.dataFilter.id].join(", "),effect:"blue",enterable:!1,placement:"top","popper-class":"filter-dep-info"},{default:C((()=>[f("span",null,g(e.usedFilters[e.dataFilter.id].length)+" 个组件正在调用",1)])),_:1},8,["content"]))]),f("div",ee,[f(o,{content:"删除"},{default:C((()=>[f("i",{class:"v-icon-close del-btn",onClick:a[2]||(a[2]=a=>e.removeFilter(e.dataFilter.id))})])),_:1})]),e.isEnabled?(u(),p(v,{key:1},[e.errMsg?(u(),p(r,{key:0,content:e.errMsg,effect:"blue",enterable:!1,placement:"left","popper-class":"is-error"},{default:C((()=>[ae])),_:1},8,["content"])):(u(),p("div",te))],64)):(u(),p("div",{key:2,class:["filter-dot c",{"--none":e.isNew}]},null,2))])]),f("div",{class:"toggle-btn",onClick:a[3]||(a[3]=(...a)=>e.toggleEditor&&e.toggleEditor(...a))},[le])]),e.isOpened?(u(),p(b,{key:0},{default:C((()=>[k(f("div",se,[f("div",ie,[ne,f(c,{language:"javascript",code:e.code,height:180,"editor-class":"filter-editor",onChange:e.changeCode,onBlur:e.updateCode},null,8,["code","onChange","onBlur"]),de,f("div",oe,[e.isEdited?(u(),p("div",re,"未保存")):w("",!0),f(m,{size:"mini",class:"bolder-btn",onClick:e.cancelEdit},{default:C((()=>[S(g(0===e.dataFilter.id?"取消":e.isEdited?"撤销":"取消"),1)])),_:1},8,["onClick"]),f(m,{type:"primary",size:"mini",class:"bolder-btn",loading:e.loading,onClick:e.saveData},{default:C((()=>[S(g(0===e.dataFilter.id||e.isEdited?"保存":"完成"),1)])),_:1},8,["loading","onClick"])])])],512),[[D,e.collapse]])])),_:1})):w("",!0)],2)};var ce=n({name:"FilterConfig",components:{FilterCollapsePanel:H},setup(){const e=b(void 0),a=b(null),t=F("apiDataConfig"),l=F("refreshData"),s=o((()=>{const e=t.value.pageFilters.map((e=>e.id));return _.dataFilters.filter((a=>!e.includes(a.id)))})),i=o((()=>t.value.pageFilters.reduce(((e,a)=>{const t=_.dataFilters.find((e=>e.id==a.id));return t&&e.push(t),e}),[]))),n=o((()=>{const e=[...N.coms,...N.subComs],a=Object.create(null);return e.forEach((e=>{for(const t in e.apiData){e.apiData[t].pageFilters.forEach((t=>{a[t.id]?a[t.id].push(e.alias):a[t.id]=[e.alias]}))}})),a})),d=o((()=>t.value.pageFilters.reduce(((e,a)=>(e[a.id]=a.enabled,e)),{})));return x("usedFilters",n),x("enabledFilters",d),x("onUsedChange",((e,a)=>{t.value.pageFilters.find((a=>a.id===e)).enabled=a,l()})),x("editFilterName",((e,a)=>{const t=e.trim();t&&a.name!==t&&(a.name=t,a.id>0&&_.updateFilterName(a))})),x("removeFilter",(e=>{e>0?(t.value.pageFilters=t.value.pageFilters.filter((a=>a.id!==e)),l()):a.value=null})),x("saveFilter",(async e=>{if(e.id>0)await _.updateFilter(e),d[e.id]&&l();else{const s=await _.createFilter(e);t.value.pageFilters.push({id:s,enabled:!0}),a.value=null,l()}})),{filterId:e,apiDataConfig:t,dataFilters:s,selectedFilters:i,newDataFilter:a,selectFilter:e=>{t.value.pageFilters.push({id:e,enabled:!0}),l()},addFilter:()=>{a.value||(a.value={id:0,name:"新建过滤器",code:"return data;",origin:"return data;",projectId:0,createAt:"",updateAt:""})}}}});const ue={class:"filter-list"},pe={class:"add-filter"},ve=f("i",{class:"el-icon-plus icon-add"},null,-1),fe=f("div",{class:"filter-dragging-wp"},null,-1),ge=f("div",{class:"drag-indicator"},null,-1);ce.render=function(e,a,t,l,s,i){const n=h("filter-collapse-panel"),d=h("el-option"),o=h("el-select");return u(),p("div",{class:["filter-wp",{"--disabled":!e.apiDataConfig.config.useFilter}]},[f("div",ue,[(u(!0),p(v,null,E(e.selectedFilters,(e=>(u(),p(n,{key:e.id,"data-filter":e},null,8,["data-filter"])))),128)),e.newDataFilter?(u(),p(n,{key:0,"data-filter":e.newDataFilter,"is-new":""},null,8,["data-filter"])):w("",!0),f("div",pe,[f(o,{"model-value":e.filterId,size:"mini",filterable:"",placeholder:"添加过滤器",class:"datav-new-select filter-select","popper-class":"datav-new-select-option",onChange:e.selectFilter},{default:C((()=>[(u(!0),p(v,null,E(e.dataFilters,(e=>(u(),p(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["model-value","onChange"]),f("div",{class:"new-filter-btn",onClick:a[1]||(a[1]=(...a)=>e.addFilter&&e.addFilter(...a))},[ve])])]),fe,ge],2)};var me=n({name:"FieldGrid",props:{fields:{type:Object}}});const be=m();r("data-v-c0253736");const Fe={key:0,class:"field-wp"},ye=f("div",{class:"field-info"},"数据相应结果应为列表，列表元素包含如下字段",-1),he={class:"field-grid"},we=f("div",{class:"field-item field-title"},"字段",-1),Ce=f("div",{class:"field-item field-title"},"映射",-1),ke=f("div",{class:"field-item field-title"},"说明",-1),De={class:"field-item"},Se={class:"field-item"},_e={class:"field-item"};c();const Ne=be(((e,a,t,l,s,i)=>e.fields?(u(),p("div",Fe,[ye,f("div",he,[we,Ce,ke,(u(!0),p(v,null,E(e.fields,((e,a)=>(u(),p(v,{key:a},[f("div",De,g(a),1),f("div",Se,g(e.map||"-"),1),f("div",_e,g(e.description||"-"),1)],64)))),128))])])):w("",!0)));me.render=Ne,me.__scopeId="data-v-c0253736";var xe=n({name:"SourceDrawer",components:{FilterConfig:ce,FieldGrid:me,DsStaticEditor:j((()=>O((()=>import("./ds-static-editor.b63f157e.js")),["/assets/ds-static-editor.b63f157e.js","/assets/index.15bc13ac.js","/assets/index.5c85043a.css"]))),DsApiEditor:j((()=>O((()=>import("./ds-api-editor.06955e70.js")),["/assets/ds-api-editor.06955e70.js","/assets/ds-api-editor.e4cdc83e.css","/assets/index.15bc13ac.js","/assets/index.5c85043a.css"])))},setup(){const e=b(!1),a=b(!1),t=P,l=T(),s=F("com"),n=F("apiConfig"),d=F("apiDataConfig"),r=F("apiName"),c=o((()=>{const e=V.dataStatusMap[s.value.id];return e?e[r]:{}})),u=o((()=>{const e=V.originMap[s.value.id];return e?e[r]:""})),p=o((()=>{const e=V.dataMap[s.value.id];return e?e[r]:""})),v=async()=>{await A(s.value.id,r,n.value,d.value)};return x("refreshData",v),x("dataStatus",c),{visible:e,visiblePreview:a,apiType:t,datasources:l,com:s,apiConfig:n,apiDataConfig:d,dataStatus:c,dataOrign:u,resData:p,open:()=>{e.value=!0},changeSource:e=>{switch(e){case P.api:void 0===d.value.config.api&&(d.value.config=i(i({},d.value.config),U()))}},refreshData:v}}});const Ee=f("p",{class:"source-drawer-title"},"设置数据源",-1),je={class:"datasource-selector"},Oe=f("label",{class:"datasource-selector-title"},"数据源类型",-1),Te={class:"datasource-select"},Ve={class:"datav-new-select-wp"},Pe={class:"ds-preview-content"},Ue=f("div",{class:"ds-response-btn"},[f("i",{class:"v-icon-search"}),S(" 预览数据源返回结果 ")],-1),Ae=f("span",{class:"use-filter-text"},"数据过滤器",-1),Ie=f("span",{class:"tutorial-popup"},"教程",-1),Me=f("span",null,"数据响应结果",-1),ze={class:"data-response"};xe.render=function(e,a,t,l,s,i){const n=h("el-option"),d=h("el-select"),o=h("ds-static-editor"),r=h("ds-api-editor"),c=h("g-monaco-editor"),g=h("el-popover"),m=h("el-checkbox"),b=h("filter-config"),F=h("field-grid"),y=h("el-drawer");return u(),p(y,{modelValue:e.visible,"onUpdate:modelValue":a[5]||(a[5]=a=>e.visible=a),"custom-class":"source-drawer",size:"500px"},{title:C((()=>[Ee])),default:C((()=>[e.visible?(u(),p(v,{key:0},[f("div",{class:["step-title",{"--error":!!e.dataStatus.errSource}]}," 数据源 ",2),f("div",je,[Oe,f("div",Te,[f("div",Ve,[f(d,{modelValue:e.apiDataConfig.type,"onUpdate:modelValue":a[1]||(a[1]=a=>e.apiDataConfig.type=a),size:"mini",filterable:"",class:"datav-new-select","popper-class":"datav-new-select-option",onChange:e.changeSource},{default:C((()=>[(u(!0),p(v,null,E(e.datasources,((e,a)=>(u(),p(n,{key:a,label:e,value:a},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])])]),e.apiDataConfig.type===e.apiType.static?(u(),p(o,{key:0})):e.apiDataConfig.type===e.apiType.api?(u(),p(r,{key:1})):w("",!0),f(g,{visible:e.visiblePreview,"onUpdate:visible":a[2]||(a[2]=a=>e.visiblePreview=a),placement:"left",width:400,"popper-class":"editor-popover"},{reference:C((()=>[Ue])),default:C((()=>[f("div",Pe,[f(c,{language:"json","read-only":!0,"auto-format":!0,height:180,code:e.dataOrign},null,8,["code"])])])),_:1},8,["visible"]),f("div",{class:["step-title",{"--error":!!e.dataStatus.errFilter}]},[f(m,{modelValue:e.apiDataConfig.config.useFilter,"onUpdate:modelValue":a[3]||(a[3]=a=>e.apiDataConfig.config.useFilter=a),class:"use-filter-btn"},null,8,["modelValue"]),Ae,Ie],2),f(b),f(F,{fields:e.apiConfig.fields},null,8,["fields"]),f("div",{class:["step-title",{"--error":!!e.dataStatus.errSource||!!e.dataStatus.errFilter}]},[Me,f("i",{class:"el-icon-refresh refresh-btn",onClick:a[4]||(a[4]=(...a)=>e.refreshData&&e.refreshData(...a))})],2),f("div",ze,[f(c,{language:"json","read-only":!0,"auto-format":!0,code:e.resData},null,8,["code"])])],64)):w("",!0)])),_:1},8,["modelValue"])};var Be=n({name:"SourcePanel",components:{DisplayApiStatus:M,SourceDrawer:xe},props:{apiName:{type:String,required:!0},activeName:String,collapse:Boolean},setup(e){const a=o((()=>e.apiName===e.activeName)),t=b(null),l=T(),s=F("com"),i=o((()=>s.value.apis[e.apiName])),n=o((()=>s.value.apiData[e.apiName]));x("apiConfig",i),x("apiDataConfig",n),x("apiName",e.apiName);const r=o((()=>{const a=V.dataMap[s.value.id];return a?a[e.apiName]:""})),c=o((()=>{const a=V.fieldStatusMap[s.value.id];return a?a[e.apiName]:{}})),u=o((()=>{const e=Object.values(c.value);return e.includes(I.loading)?d.loading:e.includes(I.failed)?d.incomplete:d.completed})),p=F("changePanel");return{visible:a,sourceDrawerRef:t,datasources:l,com:s,apiConfig:i,apiDataConfig:n,fieldsStatus:c,totalStatus:u,datav_data:r,toggle:()=>{e.collapse&&p(e.apiName)},openSourceDrawer:()=>{var e;null==(e=t.value)||e.open()},refreshData:()=>{A(s.value.id,e.apiName,i.value,n.value)}}}});const qe=m();r("data-v-4b60f1c2");const Re={class:"api-editor-title"},$e={key:0,class:"el-icon-arrow-right api-fold-icon"},Ge={class:"api-status success"},Le={class:"attr-source-wp"},He={class:"data-attr-table-container"},Ze={class:"data-attr-table"},Je=f("thead",{class:"table-head"},[f("tr",{class:"table-head-row"},[f("th",{class:"th-item column-item attr-name"}," 字段 "),f("th",{class:"th-item column-item attr-value"}," 映射 "),f("th",{class:"th-item column-item attr-status"}," 状态 ")])],-1),Ke={class:"table-body"},Qe={class:"column-item attr-name"},We={class:"ellipsis2"},Xe={class:"column-item attr-value"},Ye={class:"column-item attr-status"},ea={key:1,class:"table-body-row"},aa=f("td",{class:"column-item attr-name"},[f("span",null,"任意")],-1),ta=f("td",{class:"column-item attr-value"},null,-1),la={class:"column-item attr-status"},sa={class:"data-source"},ia=f("div",{class:"data-result-title"}," 数据响应结果 ",-1),na={class:"auto-update-config"},da=S(" 自动更新选项 "),oa=S(" 秒一次 "),ra={class:"data-flow-wp"},ca={class:"ds-line"},ua={class:"ds-title"},pa=f("span",{class:"ds-title-text"},"数据源",-1),va={class:"ds-type-text"},fa=S(" 配置数据源 "),ga={class:"ds-line mt5"},ma=f("span",null,"数据响应结果 ( 只读 ) ",-1),ba={class:"ds-dots"},Fa=f("span",{class:"ds-dot"},null,-1),ya=f("span",{class:"ds-dot"},null,-1),ha={class:"data-response"};c();const wa=qe(((e,a,t,l,s,i)=>{const n=h("display-api-status"),d=h("el-tooltip"),o=h("g-input"),r=h("el-checkbox"),c=h("el-button"),m=h("g-monaco-editor"),b=h("source-drawer");return u(),p("div",{class:["api-editor",{"--disable-fold":!e.collapse,"--fold":e.collapse&&e.visible}]},[f("div",Re,[f("div",{class:"api-desc ellipsis2",onClick:a[1]||(a[1]=(...a)=>e.toggle&&e.toggle(...a))},[e.collapse?(u(),p("i",$e)):w("",!0),S(" "+g(e.apiConfig.description||"数据接口"),1)]),f("div",Ge,[f(n,{status:e.totalStatus,"success-text":"配置完成"},null,8,["status"])])]),k(f("div",Le,[f("div",He,[f("table",Ze,[Je,f("tbody",Ke,[Object.keys(e.apiConfig.fields).length>0?(u(!0),p(v,{key:0},E(e.apiConfig.fields,((a,t)=>(u(),p("tr",{key:t,class:"table-body-row"},[f("td",Qe,[f(d,{content:a.description,placement:"left",effect:"blue"},{default:qe((()=>[f("span",We,g(t),1)])),_:2},1032,["content"])]),f("td",Xe,[f(o,{"model-value":a.map,placeholder:"可自定义",class:"attr-input",onChange:e=>a.map=e},null,8,["model-value","onChange"])]),f("td",Ye,[f(n,{status:e.fieldsStatus[t],optional:a.optional},null,8,["status","optional"])])])))),128)):(u(),p("tr",ea,[aa,ta,f("td",la,[f(n,{status:"completed"})])]))])])]),f("div",sa,[ia,f("div",na,[f(r,{modelValue:e.apiConfig.useAutoUpdate,"onUpdate:modelValue":a[2]||(a[2]=a=>e.apiConfig.useAutoUpdate=a),class:"auto-update-checkbox"},{default:qe((()=>[da])),_:1},8,["modelValue"]),f(o,{"model-value":e.apiConfig.autoUpdate,type:"number",disabled:!e.apiConfig.useAutoUpdate,class:"update-interval-input",onChange:a[3]||(a[3]=a=>e.apiConfig.autoUpdate=a)},null,8,["model-value","disabled"]),oa]),f("div",ra,[f("div",ca,[f("div",ua,[pa,f("span",va,g(e.datasources[e.apiDataConfig.type]),1)]),f(c,{size:"mini",class:"ds-action-btn",onClick:e.openSourceDrawer},{default:qe((()=>[fa])),_:1},8,["onClick"])]),f("div",ga,[ma,f(d,{content:"刷新数据",placement:"left",effect:"blue"},{default:qe((()=>[f("i",{class:"el-icon-refresh refresh-btn",onClick:a[4]||(a[4]=(...a)=>e.refreshData&&e.refreshData(...a))})])),_:1})]),f("div",ba,[f("span",{class:["ds-dot",["completed"===e.totalStatus?"active":"error"]]},null,2),Fa,ya])]),f("div",ha,[f(m,{language:"json","read-only":!0,"auto-format":!0,code:e.datav_data,height:250,"full-screen-title":"数据响应结果"},null,8,["code"])])])],512),[[D,e.visible]]),f(b,{ref:"sourceDrawerRef"},null,512)],2)}));Be.render=wa,Be.__scopeId="data-v-4b60f1c2";export default Be;
